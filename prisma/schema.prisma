generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model merchants {
  id               String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name             String         @db.VarChar(255)
  industry         String?        @db.VarChar(100)
  cashback_percent Decimal?       @db.Decimal(5, 2)
  settings         Json?
  created_at       DateTime?      @default(now())

  // White-labeling / Branding
  logo_url         String?        @db.VarChar(500)
  primary_color    String?        @db.VarChar(7)   // Hex color e.g. #FF6B35
  secondary_color  String?        @db.VarChar(7)
  custom_domain    String?        @db.VarChar(255) // e.g. analytics.merchant.com

  // API Access
  api_key          String?        @unique @db.VarChar(64)
  api_key_created  DateTime?
  api_rate_limit   Int?           @default(1000)   // requests per hour

  // Webhooks
  webhook_url      String?        @db.VarChar(500)
  webhook_secret   String?        @db.VarChar(64)
  webhook_events   String[]       @default([])     // ["anomaly", "daily_report", "threshold_alert"]

  users            users[]
  transactions     transactions[]
  daily_metrics    daily_metrics[]
  audit_logs       audit_logs[]
  api_logs         api_logs[]
  webhook_logs     webhook_logs[]
}

model api_logs {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id String    @db.Uuid
  endpoint    String    @db.VarChar(255)
  method      String    @db.VarChar(10)
  status_code Int
  ip_address  String?   @db.VarChar(45)
  user_agent  String?
  created_at  DateTime  @default(now())

  merchant    merchants @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([created_at])
}

model webhook_logs {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id String    @db.Uuid
  event_type  String    @db.VarChar(50)
  payload     Json
  status_code Int?
  response    String?
  attempts    Int       @default(1)
  success     Boolean   @default(false)
  created_at  DateTime  @default(now())

  merchant    merchants @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([created_at])
}

model users {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String       @unique @db.VarChar(255)
  password_hash String?      @db.VarChar(255)
  name          String?      @db.VarChar(255)
  merchant_id   String?      @db.Uuid
  role          String?      @default("merchant")
  is_active     Boolean      @default(true)
  last_login    DateTime?
  created_at    DateTime?    @default(now())
  updated_at    DateTime?    @updatedAt
  // SSO fields
  sso_provider  String?      @db.VarChar(50)  // 'azure_ad', 'okta', 'google'
  sso_id        String?      @db.VarChar(255)
  
  merchant      merchants?   @relation(fields: [merchant_id], references: [id])
  audit_logs    audit_logs[]
  sessions      sessions[]

  @@index([email])
  @@index([merchant_id])
  @@index([sso_provider, sso_id])
}

// Role hierarchy enum for reference (used in application code)
// super_admin - Platform admin, full access
// admin - Merchant admin, manage users and all data
// analyst - Can view all data, create reports
// viewer - Read-only access to dashboards

model transactions {
  id               String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id      String?    @db.Uuid
  transaction_date DateTime   @db.Date
  amount           Decimal    @db.Decimal(10, 2)
  customer_id      String?
  cashback_amount  Decimal?   @db.Decimal(10, 2)
  category         String?
  created_at       DateTime?  @default(now())
  merchant         merchants? @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([merchant_id, transaction_date])
  @@index([transaction_date])
}

model daily_metrics {
  id                 String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id        String?    @db.Uuid
  date               DateTime   @db.Date
  transactions_count Int?       @default(0)
  revenue            Decimal?   @default(0) @db.Decimal(12, 2)
  unique_customers   Int?       @default(0)
  cashback_paid      Decimal?   @default(0) @db.Decimal(12, 2)
  created_at         DateTime?  @default(now())
  merchant           merchants? @relation(fields: [merchant_id], references: [id])

  @@unique([merchant_id, date])
}

// Audit logging for compliance
model audit_logs {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id     String?    @db.Uuid
  merchant_id String?    @db.Uuid
  action      String     @db.VarChar(100)  // 'login', 'view_dashboard', 'export_data', 'update_settings'
  resource    String?    @db.VarChar(100)  // 'transactions', 'analytics', 'users', 'settings'
  resource_id String?    @db.VarChar(255)
  ip_address  String?    @db.VarChar(45)
  user_agent  String?    @db.Text
  metadata    Json?      // Additional context
  created_at  DateTime   @default(now())

  user        users?     @relation(fields: [user_id], references: [id])
  merchant    merchants? @relation(fields: [merchant_id], references: [id])

  @@index([user_id])
  @@index([merchant_id])
  @@index([action])
  @@index([created_at])
}

// Session management for security
model sessions {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String    @db.Uuid
  token      String    @unique @db.VarChar(500)
  expires_at DateTime
  ip_address String?   @db.VarChar(45)
  user_agent String?   @db.Text
  created_at DateTime  @default(now())

  user       users     @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
}

// Permission definitions per role
model role_permissions {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  role       String   @db.VarChar(50)   // 'super_admin', 'admin', 'analyst', 'viewer'
  resource   String   @db.VarChar(100)  // 'dashboard', 'transactions', 'analytics', 'users', 'settings'
  action     String   @db.VarChar(50)   // 'view', 'create', 'edit', 'delete', 'export'
  created_at DateTime @default(now())

  @@unique([role, resource, action])
  @@index([role])
}
