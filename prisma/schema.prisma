generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Access tier enum
enum AccessTier {
  standard
  premium
}

model merchants {
  id               String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name             String         @db.VarChar(255)
  slug             String?        @unique @db.VarChar(100)
  industry         String?        @db.VarChar(100)
  cashback_percent Decimal?       @db.Decimal(5, 2)
  settings         Json?
  created_at       DateTime?      @default(now())

  // Access Tier - Standard (Cashback only) or Premium (Cashback + Retail)
  access_tier              AccessTier @default(standard)
  has_cashback_access      Boolean    @default(true)
  has_retail_insights      Boolean    @default(false)

  // White-labeling / Branding
  logo_url         String?        @db.VarChar(500)
  primary_color    String?        @db.VarChar(7)   // Hex color e.g. #FF6B35
  secondary_color  String?        @db.VarChar(7)
  custom_domain    String?        @db.VarChar(255) // e.g. analytics.merchant.com

  // API Access
  api_key          String?        @unique @db.VarChar(64)
  api_key_created  DateTime?
  api_rate_limit   Int?           @default(1000)   // requests per hour

  // Webhooks
  webhook_url      String?        @db.VarChar(500)
  webhook_secret   String?        @db.VarChar(64)
  webhook_events   String[]       @default([])     // ["anomaly", "daily_report", "threshold_alert"]

  users              users[]
  transactions       transactions[]
  daily_metrics      daily_metrics[]
  audit_logs         audit_logs[]
  api_logs           api_logs[]
  webhook_logs       webhook_logs[]
  campaigns          campaigns[]
  stores             stores[]
  competitor_groups  competitor_groups[]
  anomalies          anomalies[]
  recommendations    ai_recommendations[]
  churn_analyses     churn_analyses[]
  ai_chat_messages   ai_chat_messages[]
  ai_chat_sessions   ai_chat_sessions[]
}

model api_logs {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id String    @db.Uuid
  endpoint    String    @db.VarChar(255)
  method      String    @db.VarChar(10)
  status_code Int
  ip_address  String?   @db.VarChar(45)
  user_agent  String?
  created_at  DateTime  @default(now())

  merchant    merchants @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([created_at])
}

model webhook_logs {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id String    @db.Uuid
  event_type  String    @db.VarChar(50)
  payload     Json
  status_code Int?
  response    String?
  attempts    Int       @default(1)
  success     Boolean   @default(false)
  created_at  DateTime  @default(now())

  merchant    merchants @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([created_at])
}

model users {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String       @unique @db.VarChar(255)
  password_hash String?      @db.VarChar(255)
  name          String?      @db.VarChar(255)
  merchant_id   String?      @db.Uuid
  role          String?      @default("merchant")
  is_active     Boolean      @default(true)
  last_login    DateTime?
  created_at    DateTime?    @default(now())
  updated_at    DateTime?    @updatedAt
  // SSO fields
  sso_provider  String?      @db.VarChar(50)  // 'azure_ad', 'okta', 'google'
  sso_id        String?      @db.VarChar(255)
  
  merchant           merchants?         @relation(fields: [merchant_id], references: [id])
  audit_logs         audit_logs[]
  sessions           sessions[]
  ai_chat_messages   ai_chat_messages[]
  ai_chat_sessions   ai_chat_sessions[]

  @@index([email])
  @@index([merchant_id])
  @@index([sso_provider, sso_id])
}

// Role hierarchy enum for reference (used in application code)
// super_admin - Platform admin, full access
// admin - Merchant admin, manage users and all data
// analyst - Can view all data, create reports
// viewer - Read-only access to dashboards

// Gender enum for demographics
enum Gender {
  male
  female
  unknown
}

model transactions {
  id                     String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id            String?    @db.Uuid
  store_id               String?    @db.Uuid
  transaction_date       DateTime   @db.Date
  transaction_time       DateTime?
  day_of_week            Int?       // 0=Sunday, 6=Saturday
  amount                 Decimal    @db.Decimal(10, 2)
  customer_id            String?
  customer_gender        Gender?
  customer_age           Int?
  cashback_amount        Decimal?   @db.Decimal(10, 2)
  is_cashback_transaction Boolean   @default(false)
  campaign_id            String?    @db.Uuid
  category               String?
  created_at             DateTime?  @default(now())

  merchant               merchants? @relation(fields: [merchant_id], references: [id])
  store                  stores?    @relation(fields: [store_id], references: [id])
  campaign               campaigns? @relation(fields: [campaign_id], references: [id])

  @@index([merchant_id])
  @@index([merchant_id, transaction_date])
  @@index([transaction_date])
  @@index([customer_id])
  @@index([store_id])
}

model daily_metrics {
  id                   String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id          String?    @db.Uuid
  date                 DateTime   @db.Date
  transactions_count   Int?       @default(0)
  revenue              Decimal?   @default(0) @db.Decimal(12, 2)
  unique_customers     Int?       @default(0)
  cashback_paid        Decimal?   @default(0) @db.Decimal(12, 2)
  avg_receipt          Decimal?   @db.Decimal(10, 2)

  // Cashback-specific metrics
  cashback_transactions Int?      @default(0)
  cashback_revenue      Decimal?  @default(0) @db.Decimal(12, 2)

  // Demographics breakdown
  customers_male        Int?      @default(0)
  customers_female      Int?      @default(0)
  customers_age_18_24   Int?      @default(0)
  customers_age_25_34   Int?      @default(0)
  customers_age_35_44   Int?      @default(0)
  customers_age_45_54   Int?      @default(0)
  customers_age_55_64   Int?      @default(0)
  customers_age_65_plus Int?      @default(0)
  avg_customer_age      Decimal?  @db.Decimal(5, 2)

  created_at           DateTime?  @default(now())
  merchant             merchants? @relation(fields: [merchant_id], references: [id])

  @@unique([merchant_id, date])
}

// Audit logging for compliance
model audit_logs {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id     String?    @db.Uuid
  merchant_id String?    @db.Uuid
  action      String     @db.VarChar(100)  // 'login', 'view_dashboard', 'export_data', 'update_settings'
  resource    String?    @db.VarChar(100)  // 'transactions', 'analytics', 'users', 'settings'
  resource_id String?    @db.VarChar(255)
  ip_address  String?    @db.VarChar(45)
  user_agent  String?    @db.Text
  metadata    Json?      // Additional context
  created_at  DateTime   @default(now())

  user        users?     @relation(fields: [user_id], references: [id])
  merchant    merchants? @relation(fields: [merchant_id], references: [id])

  @@index([user_id])
  @@index([merchant_id])
  @@index([action])
  @@index([created_at])
}

// Session management for security
model sessions {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String    @db.Uuid
  token      String    @unique @db.VarChar(500)
  expires_at DateTime
  ip_address String?   @db.VarChar(45)
  user_agent String?   @db.Text
  created_at DateTime  @default(now())

  user       users     @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
}

// Permission definitions per role
model role_permissions {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  role       String   @db.VarChar(50)   // 'super_admin', 'admin', 'analyst', 'viewer'
  resource   String   @db.VarChar(100)  // 'dashboard', 'transactions', 'analytics', 'users', 'settings'
  action     String   @db.VarChar(50)   // 'view', 'create', 'edit', 'delete', 'export'
  created_at DateTime @default(now())

  @@unique([role, resource, action])
  @@index([role])
}

// Scheduled reports for automated email delivery
model scheduled_reports {
  id                  String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id         String    @db.Uuid
  created_by          String    @db.Uuid
  name                String    @db.VarChar(255)
  frequency           String    @db.VarChar(20)  // 'daily', 'weekly', 'monthly'
  recipients          String[]                    // Array of email addresses
  include_competitors Boolean   @default(true)
  include_historical  Boolean   @default(true)
  is_active           Boolean   @default(true)
  last_sent_at        DateTime?
  next_scheduled_at   DateTime
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  @@index([merchant_id])
  @@index([is_active, next_scheduled_at])
}

// Notification preferences for alerts
model notification_settings {
  id                  String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id             String    @unique @db.Uuid
  email_anomalies     Boolean   @default(true)
  email_weekly_digest Boolean   @default(true)
  email_threshold     Boolean   @default(true)
  slack_webhook_url   String?   @db.VarChar(500)
  slack_anomalies     Boolean   @default(false)
  slack_threshold     Boolean   @default(false)
  threshold_revenue   Decimal?  @db.Decimal(12, 2)  // Alert if revenue drops below
  threshold_txn       Int?                          // Alert if transactions drop below
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  @@index([user_id])
}

// =============================================================================
// NEW MODELS FOR CASHBACK/RETAIL INSIGHTS
// =============================================================================

// Store model for location-based analytics
model stores {
  id           String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id  String         @db.Uuid
  name         String         @db.VarChar(255)
  city         String?        @db.VarChar(100)
  address      String?        @db.VarChar(500)
  is_active    Boolean        @default(true)
  created_at   DateTime       @default(now())

  merchant     merchants      @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  transactions transactions[]

  @@index([merchant_id])
}

// Campaign model for cashback campaigns
model campaigns {
  id                  String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id         String         @db.Uuid
  name                String         @db.VarChar(255)
  start_date          DateTime       @db.Date
  end_date            DateTime       @db.Date
  budget              Decimal        @db.Decimal(15, 2)
  cashback_percentage Decimal        @db.Decimal(5, 2)
  is_active           Boolean        @default(true)
  created_at          DateTime       @default(now())

  merchant            merchants      @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  transactions        transactions[]

  @@index([merchant_id])
  @@index([is_active])
}

// Competitor group for comparison sets
model competitor_groups {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id     String    @db.Uuid
  name            String    @db.VarChar(255)
  competitor_ids  String[]  @db.Uuid  // Array of merchant IDs to compare against
  is_default      Boolean   @default(false)
  created_at      DateTime  @default(now())

  merchant        merchants @relation(fields: [merchant_id], references: [id], onDelete: Cascade)

  @@unique([merchant_id, name])
  @@index([merchant_id])
}

// Customer model for tracking individual customers
model customers {
  id                     String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  external_id            String    @unique @db.VarChar(255)
  gender                 Gender?
  birth_year             Int?
  age                    Int?
  first_transaction_date DateTime?
  last_transaction_date  DateTime?
  total_transactions     Int       @default(0)
  total_spend            Decimal   @default(0) @db.Decimal(15, 2)
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt

  @@index([external_id])
}

// Market share snapshots for retail insights
model market_share_snapshots {
  id                          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  date                        DateTime @db.Date
  merchant_id                 String   @db.Uuid
  total_sales                 Decimal  @db.Decimal(15, 2)
  market_share_by_sales       Decimal  @db.Decimal(8, 4)
  total_transactions          Int
  market_share_by_transactions Decimal @db.Decimal(8, 4)
  market_reach_3m             Decimal? @db.Decimal(8, 4)
  market_reach_6m             Decimal? @db.Decimal(8, 4)
  share_of_wallet             Decimal? @db.Decimal(8, 4)
  created_at                  DateTime @default(now())

  @@unique([date, merchant_id])
  @@index([merchant_id])
  @@index([date])
}

// Customer mobility matrix snapshots
model customer_mobility_snapshots {
  id                 String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  period_start       DateTime @db.Date
  period_end         DateTime @db.Date
  from_merchant_id   String   @db.Uuid
  to_merchant_id     String   @db.Uuid
  overlap_customers  Int
  overlap_percentage Decimal  @db.Decimal(8, 4)
  created_at         DateTime @default(now())

  @@unique([period_start, period_end, from_merchant_id, to_merchant_id])
  @@index([from_merchant_id])
  @@index([to_merchant_id])
}

// Churn analysis snapshots
model churn_analyses {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id          String    @db.Uuid
  period_start         DateTime  @db.Date
  period_end           DateTime  @db.Date
  total_customers      Int
  new_customers        Int
  retained_customers   Int
  churned_customers    Int
  churn_destinations   Json?     // Where churned customers went
  new_customer_sources Json?     // Where new customers came from
  created_at           DateTime  @default(now())

  merchant             merchants @relation(fields: [merchant_id], references: [id], onDelete: Cascade)

  @@unique([merchant_id, period_start, period_end])
  @@index([merchant_id])
}

// AI-detected anomalies
model anomalies {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id           String    @db.Uuid
  type                  String    @db.VarChar(50)   // 'spike', 'drop', 'trend_change'
  severity              String    @db.VarChar(20)   // 'low', 'medium', 'high', 'critical'
  title                 String    @db.VarChar(255)
  description           String    @db.Text
  metric                String    @db.VarChar(100)
  expected_value        Decimal   @db.Decimal(15, 2)
  actual_value          Decimal   @db.Decimal(15, 2)
  percentage_change     Decimal   @db.Decimal(8, 2)
  affected_period_start DateTime  @db.Date
  affected_period_end   DateTime  @db.Date
  context_mode          String    @default("cashback") @db.VarChar(20)  // 'cashback' or 'retail'
  is_read               Boolean   @default(false)
  is_dismissed          Boolean   @default(false)
  detected_at           DateTime  @default(now())

  merchant              merchants @relation(fields: [merchant_id], references: [id], onDelete: Cascade)

  @@index([merchant_id])
  @@index([detected_at])
  @@index([is_dismissed])
}

// AI recommendations
model ai_recommendations {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id       String    @db.Uuid
  type              String    @db.VarChar(50)   // 'campaign', 'retention', 'growth'
  priority          String    @db.VarChar(20)   // 'low', 'medium', 'high'
  title             String    @db.VarChar(255)
  description       String    @db.Text
  rationale         String    @db.Text
  suggested_actions String[]
  context_mode      String    @default("cashback") @db.VarChar(20)  // 'cashback' or 'retail'
  is_read           Boolean   @default(false)
  is_dismissed      Boolean   @default(false)
  created_at        DateTime  @default(now())

  merchant          merchants @relation(fields: [merchant_id], references: [id], onDelete: Cascade)

  @@index([merchant_id])
  @@index([created_at])
}

// AI chat message history
model ai_chat_messages {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id  String   @db.Uuid
  user_id      String?  @db.Uuid
  user_email   String?  @db.VarChar(255)
  session_id   String   @db.VarChar(100)
  role         String   @db.VarChar(20)   // 'user', 'assistant'
  content      String   @db.Text
  context_mode String   @db.VarChar(20)   // 'cashback' or 'retail'
  timestamp    DateTime @default(now())

  merchant     merchants @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  user         users?    @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([merchant_id, session_id])
  @@index([timestamp])
  @@index([user_id])
}

// AI conversation sessions (aggregated view)
model ai_chat_sessions {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  session_id     String   @unique @db.VarChar(100)
  merchant_id    String   @db.Uuid
  user_id        String?  @db.Uuid
  user_email     String?  @db.VarChar(255)
  context_mode   String   @db.VarChar(20)
  message_count  Int      @default(0)
  first_message  String?  @db.Text
  started_at     DateTime @default(now())
  last_message_at DateTime @default(now())
  flagged        Boolean  @default(false)
  starred        Boolean  @default(false)
  tags           String[] @default([])
  summary        String?  @db.Text

  merchant       merchants @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  user           users?    @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([merchant_id])
  @@index([started_at])
  @@index([flagged])
  @@index([starred])
}

// Admin AI conversation insights (meta-analysis)
model admin_conversation_insights {
  id                     String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  period_start           DateTime
  period_end             DateTime
  top_topics             Json?    // [{topic, count, example_ids}]
  pain_points            Json?    // [{issue, count, severity, example_ids}]
  feature_requests       Json?    // [{request, count, example_ids}]
  confusion_points       Json?    // [{area, count, example_ids}]
  total_conversations    Int      @default(0)
  avg_messages_per_conv  Decimal? @db.Decimal(5, 2)
  resolution_rate        Decimal? @db.Decimal(5, 2)
  full_analysis_text     String?  @db.Text
  created_at             DateTime @default(now())

  @@index([period_start, period_end])
}
